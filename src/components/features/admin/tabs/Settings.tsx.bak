"use client";

import React, { useState } from "react";
import { useRouter } from "next/navigation";
import { useOrgs } from "@/hooks/organization/use-organizations";
import { Profile, Organization } from "@/lib/supabase/types"
import { Card, CardHeader, CardTitle, CardDescription, CardContent, CardFooter } from "@/components/ui/card";
import { Label } from "@/components/ui/label";
import { Input } from "@/components/ui/input";
import { Button } from "@/components/ui/button";
import { Separator } from "@/components/ui/separator";
import { Badge } from "@/components/ui/badge";
import { Pencil } from "lucide-react";
import ProfileModal from "@/components/common/modals/ProfileModal";
import { useAdminSubscription } from "@/components/features/admin/AdminPageWrapper";
import { useUser as useClerkUser } from "@/lib/auth/client-helpers";
/** Example Org interface â€” adjust as needed. */

interface OrgSettingsProps {
    user: Profile;
    org: Organization;
    // deleteOrg: (org_id: string) => void;
    refreshOrgs?: () => void; // e.g. for refetching or side effects after update
}

const OrgSettings: React.FC<OrgSettingsProps> = ({
    user,
    org,
    refreshOrgs,
}) => {
    // Local state for org name
    const [orgName, setOrgName] = useState<string>(org.name ?? "");
    const [isProfileModalOpen, setIsProfileModalOpen] = useState(false);
    const { updateOrg } = useOrgs(user);
    const router = useRouter();
    const { subscription, isLoading: subscriptionLoading } = useAdminSubscription();
    // Example update handler (replace with real update logic)
    const handleUpdateOrg = async () => {
        // e.g., call your API to update org fields
        // await updateOrg({ id: org.id, name: orgName, ... });

        await updateOrg(orgName, org);

        refreshOrgs && refreshOrgs();

        alert("Organization updated");
    };

    // Example upgrade plan handler (replace with real billing logic)
    const handleUpgradePlan = () => {
        // Open the user profile modal instead of Stripe checkout
        setIsProfileModalOpen(true);
    };

    return (
        <>
            <Card className="mx-auto max-w-2xl">
                <CardHeader>
                    <CardTitle className="text-2xl">
                        {orgName || "Organization Settings"}
                    </CardTitle>
                    <CardDescription>Org ID: {org.id}</CardDescription>
                </CardHeader>
                <CardContent className="space-y-6">
                    <div className="space-y-2">
                        <Label htmlFor="org-name">Organization Name</Label>
                        <Input
                            id="org-name"
                            value={orgName}
                            onChange={(e) => setOrgName(e.target.value)}
                        />
                    </div>

                    <Separator />

                    <div className="space-y-3">
                        <div className="space-y-1">
                            <CardTitle className="text-xl">Billing & Plan</CardTitle>
                            <CardDescription>
                                Manage your organization&apos;s subscription and billing.
                            </CardDescription>
                        </div>
                        <div className="flex items-center gap-2">
                            <span className="text-sm text-muted-foreground">Current plan:</span>
                            {subscriptionLoading ? (
                                <Badge variant="secondary" className="text-sm font-medium">
                                    Loading...
                                </Badge>
                            ) : (
                                <>
                                    <Badge
                                        variant={subscription?.subscriptionItems?.[0]?.plan?.name === 'Pro' ? 'default' : 'secondary'}
                                        className="text-sm font-medium"
                                    >
                                        {subscription?.subscriptionItems?.[0]?.plan?.name || 'Free'}
                                    </Badge>
                                    <Button
                                        onClick={handleUpgradePlan}
                                        variant="ghost"
                                        size="sm"
                                        className="h-8 w-8 p-0"
                                        aria-label="Edit plan"
                                    >
                                        <Pencil className="h-4 w-4" />
                                    </Button>
                                </>
                            )}
                        </div>
                    </div>
                </CardContent>
                <CardFooter className="flex justify-end space-x-2">
                    <Button onClick={handleUpdateOrg} variant="default">
                        Update Org
                    </Button>
                </CardFooter>
            </Card>

            <ProfileModal
                user={user}
                isOpen={isProfileModalOpen}
                onClose={() => {
                    setIsProfileModalOpen(false);
                    router.refresh();
                }}
            />
        </>
    );
};

export default OrgSettings;
